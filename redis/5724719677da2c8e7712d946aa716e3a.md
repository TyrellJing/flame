# AOF，RDB和复制对过期键的处理

## RDB对过期键的处理

在执行SAVE命令或者BGSAVE命令创建一个RDB文件时，程序会对数据库中的键进行检查，已经过期的键不会保存在新建的RDB文件中。

在启动Redis时，如果服务器开启了RDB功能，那么服务器将对RDB文件进行载入：

- 如果服务器以主服务器模式运行，那么载入RDB文件时，程序会对文件中保存的键进行检查，未过期的键会被载入到数据库中，而过期的键会被忽略。

- 如果服务器以从服务器模式运行，那么载入RDB文件时，文件中保存的所有键，无论是否过期，都会被载入到数据库中。

## AOF对过期键的处理

- 当服务器以AOF持久化模式运行时，如果数据库中某个键已经过期，但它还没有被惰性删除或者定期删除，AOF不会因此产生任何影响。

- 当过期键被惰性删除或者定期删除后，程序会向AOF文件追加(append)一条DEL命令，来显式记录该键已被删除。

- 和生成RDB文件类似，在执行AOF重写时，程序会对数据库中的键进行检查，已过期的不会被保存到重写的AOF文件中。

## 复制功能

当服务器运行在复制模式下时，从服务器的过期删除动作由主服务器控制：

- 主服务器在删除一个过期键之后，会显示地向所有从服务器发送一个DEL命令，告知从服务器删除这个过期键。

- 从服务器在执行客户端发送的命令时，即使碰到过期键也不会将过期键删除，而是继续像处理未过期的键一样来处理过期键。

- 从服务器只有在接到主服务器发送来的DEL命令后，才会删除过期键。

通过由主服务器来控制从服务器统一地删除过期键，可以保证从服务器数据的一致性，也正是出于这个原因，当一个过期键仍然存在于主服务器的数据库时，这个过期键在从服务器里的复制品也会继续存在。

