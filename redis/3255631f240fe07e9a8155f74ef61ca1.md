# 文件事件

Redis基于Reactor模式开发了自己的网络事件处理器，这个处理器被称为文件事件处理器(file event handler)。

- 文件事件处理器使用I/O多路复用(multiplexing)程序来同时监听多个套接字，并根据套接字当前执行的任务来为套接字关联不同的事件处理器。

- 当被监听的套接字准备好连接应答(accept)，读取(read)，写入(write)，关闭(close)等操作时，与操作相对应的文件时间就会产生，这时文件处理器会调用套接字之前关联好的事件处理器来处理这些事件。

虽然文件事件处理器以单线程方式运行，但通过使用I/O多路复用程序监听多个套接字，文件事件处理器既实现了高性能的网络通信模型，又可以很好的与Redis服务器中其他同样单线程运行的模块进行对接，保持了Redis内部单线程设计的简单性。

## 文件事件处理器的构成

文件事件处理器有四个组成部分：套接字，I/O多路复用程序，文件事件分派器(dispatcher)以及事件处理器。

![](../assets/3255631f240fe07e9a8155f74ef61ca1_1.png)

- 文件事件是对套接字操作的抽象，每当一个套接字准备好执行连接应答(accept)，写入，读取，关闭等操作时，就会产生一个文件事件。因为一个服务器通常会连接多个套接字，所以多个文件事件会并发出现。

- I/O多路复用程序负责监听多个套接字，并向文件事件分派器传送那些产生了事件的套接字。尽管多个文件事件会并发出现，但I/O多路复用程序总是将所有产生事件的套接字都放到一个队列里面，然后通过这个队列，以有序，同步，每次一个的方式向文件事件分派器传送套接字。当上一个套接字产生的事件被处理完后(该套接字关联事件处理器执行完成)，I/O多路复用程序才会继续向文件事件分派器传送下一个套接字。

![](../assets/3255631f240fe07e9a8155f74ef61ca1_2.png)

- 文件事件分派器接收I/O多路复用程序传来的套接字，并根据套接字产生的事件类型，调用相关的事件处理器。

- 服务器会为不同任务的套接字关联不同的事件处理器，这些处理器是一个个函数，它们定义了某个事件发生时，服务器应该做的工作。

## I/O多路复用程序的实现

Redis的I/O多路复用程序的所有功能都是通过包装常见的select，epoll，evport和kqueue这些I/O多路复用函数库实现的，每个I/O多路复用函数库在Redis源码中都有对应的一个单独的文件，比如ae_select.c，ae_epoll.c，ae_kqueue.c等。

Redis为每个I/O多路复用函数库实现了相同的API，所以I/O多路复用程序的底层实现是可以互换的。Redis在I/O多路复用程序的实现源码中用#include宏定义了相应的规则，程序会在编译时自动选择系统中性能最高的I/O多路复用函数作为Redis的I/O多路复用底层实现

![](../assets/3255631f240fe07e9a8155f74ef61ca1_3.png)

## 事件类型

I/O多路复用程序可以监听多个套接字的ae.h/AE_READABLE事件和ae.h/AE_WRITABLE事件，这两类事件和套接字的关系如下：

- 当套接字变得可读时(客户端执行write操作或者close操作)，或者有可应答(acceptable)的套接字出现时(客户端对服务器的监听套接字执行connect操作)，套接字产生AE_READABLE事件。

- 当套接字变得可写时(客户端执行read操作)，套接字产生AE_WRITABLE事件。

I/O多路复用程序允许服务器同时监听套接字的AE_READABLE事件和AE_WRITABLE事件，如果一个套接字同时产生了这两种事件，那么文件事件分派器会优先处理AE_READABLE事件，等到AE_READABLE事件处理完后，才会处理AE_WRITABLE事件。

## 文件事件处理器

Redis为文件事件编写了多个处理器，这些事件处理器分别用于实现不同的网络通信需求。

- 为了对连接服务器的各个客户端进行应答，服务器需要监听套接字关联连接应答处理器。

- 为了接收客户端传来的命令请求，服务器要为客户端套接字关联命令请求处理器。

- 为了向客户端返回命令的执行结果，服务器要为客户端套接字关联命令回复处理器。

- 当主服务器和从服务器进行复制操作时，主服务器都需要关联特别为复制功能编写的复制处理器。

其中最常用的是连接应答处理器，命令请求处理器和命令回复处理器。有

### 连接应答处理器

networking.c/acceptTcpHandler函数是Redis的连接应答处理器，这个处理器用于对连接服务器监听套接字的客户端进行应答，具体实现为sys/socket.h/accept函数的封装。

当Redis服务器初始化时，程序会将这个连接应答处理器和服务器监听套接字的AE_READABLE事件关联起来，当有客户端用sys/socket.h/connect函数连接服务器监听的套接字时，套接字产生了AE_READABLE事件，引发连接应答处理器执行，并执行相应的套接字应答操作。

### 命令请求处理器

networking.c/readQueryFromClient函数是Redis命令的请求处理器，这个处理器负责从套接字中读入客户端发送的命令请求内容，具体实现为unistd.h/read函数的封装。

当一个客户端通过连接应答处理器成功连接到服务器后，服务器会将客户端套接字的AE_READABLE事件和命令请求处理器关联起来，当客户端向服务器发送命令请求的时候，套接字就会产生AE_READABLE事件，引发命令请求处理器执行，并执行相应的套接字读入操作。

在客户端连接服务器的整个过程中，服务器会一直为客户端套接字的AE_READABLE事件关联命令请求处理器。

### 命令回复处理器

networking.c/sendReplyToClient函数是Redis命令回复处理器，这个处理器负责将服务器执行命令得到的命令回复通过套接字返回给客户端，具体实现为unistd.h/write函数的封装。

当服务器有命令回复需要传送给客户端的时候，服务器会将客户端套接字的AE_WRITABLE事件和命令回复处理器关联起来，当客户端准备好接收服务器回传的命令回复时，就会产生AE_WRITABLE事件，引发命令回复处理器执行，并执行响应的套接字写入操作。

当命令回复发送完毕后，服务器就会解除命令回复处理器与客户端套接字的AE_WRITABLE事件之间的关联。

### API

- ae.c/aeCreateFileEvent函数接受一个套接字描述符，一个事件类型，以及一个事件处理器作为参数，将给定套接字的给定事件加入到I/O多路复用程序的监听范围之内，并对事件和事件处理器进行关联。

- ae.c/aeDeleteFileEvent函数接收一个套接字描述符和一个监听事件类型作为参数，让I/O多路复用程序取消对给定套接字的给定事件的监听，并取消事件和事件处理器之间的关联。

- ae.c/aeGetFileEvent函数接收一个套接字描述符，返回该套接字正在被监听的事件类型

    - 如果套接字没有任何事件监听，返回AE_NONE

    - 如果套接字读事件正在被监听，返回AE_READABLE

    - 如果套接字写事件正在被监听，返回AE_WRITABLE

    - 如果套接字的读事件和写事件正在被监听，返回AE_READABLE | AE_WRITABLE

- ae.c/aeWait函数接收一个套接字描述符，一个事件类型和一个以毫米为单位的参数，在给定的时间内阻塞并等待套接字的给定类型事件产生，当事件成功产生时，或者等待超时后，函数返回。

- ae.c/aeApiPoll函数接收一个sys/time.h/struct timeval结构为参数，并在指定的时间内，阻塞并等待所有被aeCreateFileEvent函数设置为监听状态的套接字产生文件事件，当有至少一个事件产生时，或者等待超时后，函数返回。

- ae.c/aeProcessEvents函数是文件事件分派器，它先调用aeApiPoll函数来等待事件产生，然后遍历所有已产生的事件，并调用相应的事件处理器来处理这些事件。

- ae.c/aeGetApiName函数返回I/O多路复用程序底层所使用的I/O多路复用函数库的名称：返回epoll表示底层为epoll的函数库，返回select表示底层为select的函数库。

### 一次完整的请求

![](../assets/3255631f240fe07e9a8155f74ef61ca1_4.png)

- 假设一个Redis服务器正在运行，那么这个服务器的监听套接字的AE_READABLE事件应该处于监听状态之下，而该事件对应的处理器为连接应答处理器。

- 如果这时有一个Redis客户端向服务器发起连接，那么监听套接字将产生AE_READABLE事件，触发连接应答处理器执行。处理器对客户端连接请求进行应答，然后创建客户端套接字，以及客户端状态，并将客户端套接字的AE_READABLE事件与命令请求处理器进行关联，使得客户端可以向服务器发送命令请求。

- 之后，假设客户端向主服务器发送一个命令请求，那么客户端套接字将产生AE_READABLE事件，引发命令请求处理器执行，处理器读取客户端的命令内容然后传递给相关程序执行。

- 执行命令执行相应的命令回复，为了将这些命令回复传回客户端，服务器会将客户端套接字的AE_WRITABLE事件与命令回复处理器进行关联，当客户端尝试读取回复命令时，将产生AE_WRITABLE事件，触发命令回复处理器执行，当命令回复处理器将命令回复全部写入套接字后，服务器会解除客户端套接字的AE_WRITABLE事件与命令回复处理器之间的关联。

































