# SQL注入原理与防护

## SQL注入原理

所谓SQL注入，就是通过把SQL命令插入到Web表单递交或页面请求的查询字符串，最终达到欺骗服务器执行恶意的SQL命令，当应用程序使用输入内容来构造动态sql语句以访问数据库时，会发生sql注入攻击。如果代码使用存储过程，而这些存储过程作为包含未筛选的用户输入的字符串来传递，也会发生sql注入。 

SQL注入式攻击的主要形式有两种：

- 一是直接将代码插入到与SQL命令串联在一起并使得其以执行的用户输入变量。由于其直接与SQL语句捆绑，故也被称为直接注入式攻击法。

- 二是一种间接的攻击方法，它将恶意代码注入要在表中存储或者作为原书据存储的字符串。在存储的字符串中会连接到一个动态的SQL命令中，以执行一些恶意的SQL代码。注入过程的工作方式是提前终止文本字符串，然后追加一个新的命令。

## SQL注入例子

- SQL注入漏洞的几种判断方法

  1. http://www.heetian.com/showtail.asp?id=40'

  2. http://www.heetian.com/showtail.asp?id=40 and 1=1

  3. http://www.heetian.com/showtail.asp?id=40 and 1=2

如果执行1后，页面上提示报错或者提示数据库错误的话，说明是存在注入漏洞的。

如果执行2后，页面正常显示，而执行③后，页面报错，那么说明这个页面是存在注入漏洞的。

因为正确的链接：http://www.heetian.com/showtail.asp?id=40 没有问题，如果如果执行1后，页面上提示报错或者提示数据库错误的话说明是不满足条件，说明查询的条件不满足，是有一个查询语句的，明是存在注入漏洞，如果执行2后，页面正常显示，而执行3后，页面报错，那么说明这个页面是存在注入漏洞的。

- 收集信息、判断数据库类型

从其返回的信息中可以判断下数据库的类型，更多可能可以知道部分数据库中的字段以及其他有用信息，为下一步攻击提供铺垫。

- 根据注入参数类型，重构SQL语句的原貌

  1. ID=40 这类注入的参数是数字型，那么SQL语句的原貌大致是：Select*from 表名 where 字段=40

  2. name=电影 这类注入的参数是字符型，SQL语句原貌大致是：Select*from 表名 where 字段=‘电影’

  3. 搜索时没有过滤参数的，如keyword=关键字，SQL语句原貌大致是：Select*from 表名 where 字段 like ‘%关键字%’

- 猜解表名、字段名（直接将SQL语句添加到URL后）

  1. and exists(select*from 表名)

    如果页面没有任何变化，说明附加条件成立，那么就是说明猜解的表名正确，反之，就是不存在这个表，接下来就继续猜解，知道正确

  2. and exists（select 字段 from 表名）

    方法原理同上

  3. 猜解字段内容（利用以上猜解出的表名和字段名 方法较古老且麻烦）

    - 猜解字段内容的长度（select top 1 len（字段名）from 表名）>0 直至猜解到>n不成立的时候，得出字段的长度为：n+1。

    - 得到长度后，猜解具体的内容（select top 1 asc（mid（username，1,1））from 表名）>0直到>m不成立时，就可以猜解出ASCII码值了。

## SQL注入防护

1.永远不要信任用户的输入。对用户的输入进行校验，可以通过正则表达式，或限制长度；对单引号和双"-"进行转换等；

2.永远不要使用动态拼装sql，可以使用参数化的sql或者直接使用存储过程进行数据查询存取；

3.永远不要使用管理员权限的数据库连接，为每个应用使用单独的权限有限的数据库连接；

4.不要把机密信息直接存放，加密或者hash掉密码和敏感的信息；

5.应用的异常信息应该给出尽可能少的提示，最好使用自定义的错误信息对原始错误信息进行包装；

6.sql注入的检测方法一般采取辅助软件或网站平台来检测，软件一般采用sql注入检测工具jsky，网站平台就有亿思网站安全平台检测工具。MDCSOFT SCAN等。采用MDCSOFT-IPS可以有效的防御SQL注入，XSS攻击等。

